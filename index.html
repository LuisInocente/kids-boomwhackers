<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Boomwhacker Composer – Student</title>

<style>
:root{
  --text:#111827;
  --muted:#6b7280;
  --circle:260px;
  --gap:22px;
  --shadow:0 16px 40px rgba(0,0,0,.12);
  --ring:rgba(255,43,43,.22);
  --btnH:44px;
  --sw:92px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#fff;
  color:var(--text);
  user-select:none;
}

header{
  position:sticky; top:0; z-index:10;
  background:#fff;
  border-bottom:1px solid rgba(0,0,0,.06);
  padding:10px 12px;
}
.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

.btn,.pill{
  height:var(--btnH);
  border:none;
  border-radius:14px;
  box-shadow:var(--shadow);
  background:#fff;
  font-size:16px;
  font-weight:900;
  display:flex;
  align-items:center;
  padding:0 14px;
}
.btn{cursor:pointer}
.btn:active{transform:translateY(1px)}
.btn.primary.playing{ box-shadow:0 0 0 6px rgba(255,43,43,.14),var(--shadow) }
.btn.toggledOff{opacity:.6}

.pill{gap:8px}
.pill label{
  font-size:11px;
  font-weight:900;
  color:var(--muted);
  text-transform:uppercase;
}
.pill input,.pill select{
  border:none;
  outline:none;
  font-size:16px;
  font-weight:900;
  background:transparent;
  appearance:none;
  width:86px;
  text-overflow:ellipsis;
  white-space:nowrap;
  overflow:hidden;
}
#projectName{ width:300px; }
#playlist{ width:320px; }

.status{
  height:var(--btnH);
  display:flex;
  align-items:center;
  padding:0 10px;
  border-radius:14px;
  background:rgba(17,24,39,.04);
  color:var(--muted);
  font-weight:900;
  font-size:13px;
  letter-spacing:.2px;
  opacity:0;
  transform:translateY(2px);
  transition:opacity .18s ease, transform .18s ease;
}
.status.show{opacity:1; transform:translateY(0);}

.palette{
  margin-top:12px;
  display:flex;
  gap:14px;
  justify-content:center;
  flex-wrap:wrap;
}
.swatch{
  width:var(--sw);
  height:var(--sw);
  border-radius:50%;
  box-shadow:var(--shadow);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:1000;
  cursor:pointer;
}
.swatch.selected{ box-shadow:0 0 0 10px rgba(255,43,43,.18),var(--shadow) }

main{
  height:calc(100vh - 170px);
  display:flex;
  align-items:center;
  justify-content:center;
}
.scroll{
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  padding:12px 18px;
}
.bars{ display:flex; gap:80px; }
.bar{
  display:flex;
  align-items:center;
  gap:20px;
  scroll-snap-align:center;
}
.barLine{
  width:6px;
  height:calc(var(--circle) + 44px);
  background:rgba(0,0,0,.15);
  border-radius:999px;
}
.beats{ display:flex; gap:var(--gap); }

/* ✅ Robust rings (no CSS var stacking) */
.beat{
  width:var(--circle);
  height:var(--circle);
  border-radius:50%;
  border:none;
  background:#fff;
  cursor:pointer;
  position:relative;
  outline:none;
  -webkit-tap-highlight-color:transparent;
  box-shadow:var(--shadow);
}

/* Cursor ring inside */
.beat.cursor{
  box-shadow:0 0 0 4px rgba(17,24,39,.25) inset, var(--shadow);
}

/* ✅ Playhead ring as OUTLINE (very reliable) */
.beat.playhead{
  outline:18px solid var(--ring);
  outline-offset:0px;
}

/* Both cursor + playhead */
.beat.cursor.playhead{
  outline:18px solid var(--ring);
  outline-offset:0px;
  box-shadow:0 0 0 4px rgba(17,24,39,.25) inset, var(--shadow);
}

.label{
  font-size:64px;
  font-weight:1000;
  text-shadow:0 3px 14px rgba(0,0,0,.14);
}

.lowBar{
  position:absolute;
  left:0; right:0;
  bottom:0;
  height:22%;
  background:rgba(0,0,0,.78);
  pointer-events:none;
}

.corner{
  position:fixed;
  right:12px; bottom:12px;
  font-size:12px;
  font-weight:900;
  color:var(--muted);
  background:#fff;
  padding:10px 12px;
  border-radius:14px;
  box-shadow:var(--shadow);
}

@media(max-width:700px){
  :root{--circle:220px; --sw:86px;}
  .label{font-size:54px}
  #projectName{ width:240px; }
  #playlist{ width:260px; }
}
</style>
</head>

<body>
<header>
  <div class="controls">
    <button id="play" class="btn primary">Play</button>
    <button id="stop" class="btn">Stop</button>
    <button id="drums" class="btn">Drums: ON</button>
    <button id="fs" class="btn">Fullscreen</button>

    <div class="pill">
      <label>BPM</label>
      <input id="bpm" type="number" min="40" max="240" value="120" />
      <button id="applyBpm" class="btn">Apply</button>
    </div>

    <div class="pill">
      <label>Bars</label>
      <input id="barsInput" type="number" min="1" max="16" value="16" />
      <button id="applyBars" class="btn">Apply</button>
    </div>

    <div class="pill">
      <label>Project</label>
      <input id="projectName" placeholder="Name…" />
    </div>

    <button id="saveToPlaylist" class="btn">Save</button>
    <div id="saveStatus" class="status">Saved ✓</div>

    <div class="pill">
      <label>Playlist</label>
      <select id="playlist"></select>
    </div>

    <button id="deleteFromPlaylist" class="btn">Delete</button>
    <button id="loadFile" class="btn">Load File</button>
    <button id="export" class="btn">Export</button>

    <input id="fileInput" type="file" accept=".json,application/json" style="display:none" />
  </div>

  <div class="palette" id="palette"></div>
</header>

<main>
  <div class="scroll">
    <div class="bars" id="bars"></div>
  </div>
</main>

<div class="corner">Muziek met meester Luis 2025</div>

<script>
(() => {
"use strict";

/* =========================
   CONFIG
========================= */
const NOTES = [
  { n:"C",  m:60, c:"#e53935" },
  { n:"D",  m:62, c:"#fb8c00" },
  { n:"E",  m:64, c:"#fdd835" },
  { n:"F",  m:65, c:"#8ed265" },
  { n:"G",  m:67, c:"#008a8c" },
  { n:"A",  m:69, c:"#1e88e5" },
  { n:"B",  m:71, c:"#6a1b9a" },
  { n:"C2", m:72, c:"#c62828" }
];
const KEYMAP = { c:0, d:1, e:2, f:3, g:4, a:5, b:6 };

const BEATS = 4;
const MAX_BARS = 16;

const STORE_KEY = "boomwhacker_student_projects";
const LAST_ACTIVE_KEY = "boomwhacker_student_last_active_clean_v2";

const COUNT_IN_BARS = 1;

/* boomwhacker envelope */
const BW_ATTACK  = 0.01;
const BW_PEAK    = 0.70;
const BW_SUSTAIN = 0.32;
const BW_RELEASE = 0.30;

/* =========================
   STATE
========================= */
let song = { bpm:120, bars:16 };
let grid = Array.from({length:song.bars}, () => Array(BEATS).fill(null));

let selected = 0;
let drumsOn = true;

// cursor
let curBar = 0;
let curBeat = 0;

// audio
let ctx = null;
let synthGain = null;
let drumGain = null;

// transport
let isPlaying = false;
let timerId = null;
let rafId = null;
let nextTime = 0;
let playBar = 0;
let playBeat = 0;
let countInStartAt = 0;
let songStartAt = 0;

// ✅ scheduled playhead tracking
let playEvents = [];   // {t,b,i}
let playheadEl = null; // current .playhead element

let statusTimer = null;

/* =========================
   DOM
========================= */
const $ = (id) => document.getElementById(id);
const clamp = (v,a,b) => Math.max(a, Math.min(b, v));

function isTypingTarget(t){
  const tag = (t?.tagName || "").toUpperCase();
  return tag==="INPUT" || tag==="TEXTAREA" || tag==="SELECT" || t?.isContentEditable;
}

function flashSaved(){
  const el = $("saveStatus");
  el.classList.add("show");
  if(statusTimer) clearTimeout(statusTimer);
  statusTimer = setTimeout(()=>el.classList.remove("show"), 900);
}

/* =========================
   HELPERS
========================= */
const midiToFreq = (m) => 440 * Math.pow(2, (m - 69) / 12);
const beatDur = () => 60 / song.bpm;
const countInDuration = () => COUNT_IN_BARS * BEATS * beatDur();
const isLowMidi = (midi) => midi != null && midi < 60;

function labelForMidi(midi){
  if(midi == null) return "";
  const exact = NOTES.find(x => x.m === midi);
  if(exact) return exact.n;
  const hi = NOTES.find(x => x.m === midi + 12);
  if(hi) return hi.n;
  return "?";
}
function colorForMidi(midi){
  if(midi == null) return "#fff";
  const exact = NOTES.find(x => x.m === midi);
  if(exact) return exact.c;
  const hi = NOTES.find(x => x.m === midi + 12);
  if(hi) return hi.c;
  return "#ddd";
}
function toggleOctave(midi){
  if(midi == null) return null;
  return isLowMidi(midi) ? (midi + 12) : (midi - 12);
}

/* =========================
   AUDIO
========================= */
let noiseCache = null;

function ensureAudio(){
  if(ctx) return;
  ctx = new (window.AudioContext || window.webkitAudioContext)();

  synthGain = ctx.createGain();
  drumGain  = ctx.createGain();
  synthGain.gain.value = 0.8;
  drumGain.gain.value  = 0.7;

  synthGain.connect(ctx.destination);
  drumGain.connect(ctx.destination);
}

function playBoom(midi, t, baseLen){
  const o = ctx.createOscillator();
  const g = ctx.createGain();

  o.type = "sine";
  o.frequency.setValueAtTime(midiToFreq(midi), t);

  const sustainEnd = t + Math.max(0.03, baseLen);
  const releaseEnd = sustainEnd + BW_RELEASE;

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(BW_PEAK, t + BW_ATTACK);
  g.gain.exponentialRampToValueAtTime(BW_SUSTAIN, sustainEnd);
  g.gain.exponentialRampToValueAtTime(0.0001, releaseEnd);

  o.connect(g);
  g.connect(synthGain);

  o.start(t);
  o.stop(releaseEnd + 0.03);
}

function noiseBuf(){
  if(noiseCache) return noiseCache;
  const b = ctx.createBuffer(1, Math.floor(ctx.sampleRate * 0.3), ctx.sampleRate);
  const d = b.getChannelData(0);
  for(let i=0;i<d.length;i++) d[i] = (Math.random()*2-1) * (1 - i/d.length);
  noiseCache = b;
  return b;
}

function kick(t){
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type="sine";
  o.frequency.setValueAtTime(90,t);
  o.frequency.exponentialRampToValueAtTime(40,t+.18);
  g.gain.setValueAtTime(.001,t);
  g.gain.exponentialRampToValueAtTime(.8,t+.01);
  g.gain.exponentialRampToValueAtTime(.001,t+.25);
  o.connect(g); g.connect(drumGain);
  o.start(t); o.stop(t+.3);
}
function snare(t){
  const s=ctx.createBufferSource(); s.buffer=noiseBuf();
  const bp=ctx.createBiquadFilter(); bp.type="bandpass"; bp.frequency.value=1800; bp.Q.value=.8;
  const g=ctx.createGain();
  g.gain.setValueAtTime(.001,t);
  g.gain.exponentialRampToValueAtTime(.5,t+.01);
  g.gain.exponentialRampToValueAtTime(.001,t+.18);
  s.connect(bp); bp.connect(g); g.connect(drumGain);
  s.start(t); s.stop(t+.22);
}
function hat(t){
  const s=ctx.createBufferSource(); s.buffer=noiseBuf();
  const hp=ctx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=6000;
  const g=ctx.createGain();
  g.gain.setValueAtTime(.001,t);
  g.gain.exponentialRampToValueAtTime(.12,t+.005);
  g.gain.exponentialRampToValueAtTime(.001,t+.06);
  s.connect(hp); hp.connect(g); g.connect(drumGain);
  s.start(t); s.stop(t+.08);
}

function playDrums(beatIndex, t){
  if(!drumsOn) return;
  const d = beatDur();
  hat(t); hat(t + d/2);
  if(beatIndex===0 || beatIndex===2) kick(t);
  if(beatIndex===1 || beatIndex===3) snare(t);
}

function countClick(beatIndex, t){
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  const freq = (beatIndex === 0) ? 1320 : 880;

  o.type = "square";
  o.frequency.setValueAtTime(freq, t);

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.25, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.08);

  o.connect(g);
  g.connect(drumGain);

  o.start(t);
  o.stop(t + 0.10);
}

/* =========================
   UI: GRID + RINGS
========================= */
function getBeatEl(b,i){
  return document.querySelector(`.beat[data-b="${b}"][data-i="${i}"]`);
}

function paintBeat(btn, midi){
  btn.innerHTML = "";
  btn.style.background = "#fff";
  if(midi == null) return;

  btn.style.background = colorForMidi(midi);

  const d=document.createElement("div");
  d.className="label";
  d.textContent = labelForMidi(midi);
  btn.appendChild(d);

  if(isLowMidi(midi)){
    const strip=document.createElement("div");
    strip.className="lowBar";
    btn.appendChild(strip);
  }
}

function repaintAllBeats(){
  for(let b=0;b<song.bars;b++){
    for(let i=0;i<BEATS;i++){
      const el = getBeatEl(b,i);
      if(el) paintBeat(el, grid[b][i]);
    }
  }
}

function clearPlayhead(){
  if(playheadEl){
    playheadEl.classList.remove("playhead");
    playheadEl = null;
  }
}

function setPlayhead(b,i,keepView=true){
  const el = getBeatEl(b,i);
  if(!el) return;

  if(playheadEl && playheadEl !== el) playheadEl.classList.remove("playhead");
  playheadEl = el;
  playheadEl.classList.add("playhead");

  if(keepView && i===0){
    const barEl=document.querySelector(`.bar[data-b="${b}"]`);
    if(barEl) barEl.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"});
  }
}

function syncIdlePlayheadToCursor(){
  if(!isPlaying) setPlayhead(curBar, curBeat, false);
}

function setCursor(b,i,keepView=false){
  curBar = clamp(b,0,song.bars-1);
  curBeat = clamp(i,0,BEATS-1);

  document.querySelectorAll(".beat.cursor").forEach(x=>x.classList.remove("cursor"));
  const el = getBeatEl(curBar,curBeat);
  if(el) el.classList.add("cursor");

  if(keepView && curBeat===0){
    const barEl=document.querySelector(`.bar[data-b="${curBar}"]`);
    if(barEl) barEl.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"});
  }

  syncIdlePlayheadToCursor();
}

function setCell(b,i,midi){
  grid[b][i] = midi;
  const el = getBeatEl(b,i);
  if(el) paintBeat(el, midi);
}

function applyCellAction(mod, b, i){
  setCursor(b,i,true);

  const cur = grid[b][i];
  let next = null;

  if(mod){
    next = (cur != null) ? toggleOctave(cur) : (NOTES[selected].m - 12);
  }else{
    const chosen = NOTES[selected].m;
    next = (cur === chosen) ? null : chosen;
  }

  setCell(b,i,next);

  if(next != null){
    ensureAudio(); ctx.resume();
    playBoom(next, ctx.currentTime + 0.01, 0.18);
  }
}

function makeBeatButton(b,i){
  const bt=document.createElement("button");
  bt.className="beat";
  bt.type="button";
  bt.dataset.b=b; bt.dataset.i=i;

  paintBeat(bt, grid[b][i]);

  bt.addEventListener("contextmenu",(e)=>e.preventDefault());

  bt.addEventListener("pointerdown",(e)=>{
    if(e.button !== 0) return;
    const mod = !!(e.ctrlKey || e.metaKey);
    if(mod) e.preventDefault();
    applyCellAction(mod, b, i);
  }, {capture:true});

  bt.addEventListener("click",(e)=>{
    if(e.ctrlKey || e.metaKey) return;
    applyCellAction(false, b, i);
  });

  return bt;
}

function drawBars(){
  const wrap=$("bars");
  wrap.innerHTML="";

  for(let b=0;b<song.bars;b++){
    const bar=document.createElement("div");
    bar.className="bar";
    bar.dataset.b=b;

    const line=document.createElement("div");
    line.className="barLine";
    bar.appendChild(line);

    const beats=document.createElement("div");
    beats.className="beats";
    for(let i=0;i<BEATS;i++) beats.appendChild(makeBeatButton(b,i));

    bar.appendChild(beats);
    wrap.appendChild(bar);
  }

  setCursor(curBar, curBeat, false);
}

/* =========================
   PALETTE
========================= */
function drawPalette(){
  const p=$("palette");
  p.innerHTML="";
  NOTES.forEach((note,i)=>{
    const s=document.createElement("div");
    s.className="swatch";
    s.style.background=note.c;
    s.textContent=note.n;
    s.onclick=()=>{ selected=i; markPalette(); };
    p.appendChild(s);
  });
  markPalette();
}
function markPalette(){
  document.querySelectorAll(".swatch").forEach((s,i)=>{
    s.classList.toggle("selected", i===selected);
  });
}

/* =========================
   TRANSPORT (visual follows scheduled beats)
========================= */
function scheduleAudio(){
  const lookahead=0.15;

  while(nextTime < ctx.currentTime + lookahead){
    const t = nextTime;

    if(t < songStartAt){
      const d=beatDur();
      const steps=Math.floor((t - countInStartAt)/d);
      const beatIndex=((steps % BEATS)+BEATS)%BEATS;
      countClick(beatIndex,t);
    }else{
      const b=playBar, i=playBeat;

      playEvents.push({ t, b, i });
      if(playEvents.length > 64) playEvents.shift();

      playDrums(i,t);

      const v=grid[b][i];
      if(v!=null) playBoom(v, t, beatDur()*0.70);

      playBeat++;
      if(playBeat>=BEATS){
        playBeat=0;
        playBar=(playBar+1)%song.bars;
      }
    }

    nextTime += beatDur();
  }
}

function updatePlayhead(){
  if(!isPlaying || !ctx) return;

  const now = ctx.currentTime;

  if(now < songStartAt){
    clearPlayhead();
    rafId = requestAnimationFrame(updatePlayhead);
    return;
  }

  let last = null;
  for(let k = playEvents.length - 1; k >= 0; k--){
    const ev = playEvents[k];
    if(ev.t <= now){ last = ev; break; }
  }

  if(last) setPlayhead(last.b, last.i, true);
  else setPlayhead(0,0,true);

  rafId = requestAnimationFrame(updatePlayhead);
}

function start(){
  if(isPlaying) return;
  ensureAudio(); ctx.resume();

  playBar=0; playBeat=0;
  setCursor(0,0,true);

  isPlaying=true;
  $("play").classList.add("playing");
  $("play").textContent="Playing";

  countInStartAt = ctx.currentTime + 0.10;
  songStartAt = countInStartAt + countInDuration();
  nextTime = countInStartAt;

  playEvents = [];
  clearPlayhead();

  if(rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(updatePlayhead);

  timerId = setInterval(scheduleAudio,25);
}

function stop(){
  if(!isPlaying) return;
  isPlaying=false;

  $("play").classList.remove("playing");
  $("play").textContent="Play";

  clearInterval(timerId); timerId=null;
  if(rafId) cancelAnimationFrame(rafId); rafId=null;

  syncIdlePlayheadToCursor();
}

/* =========================
   STORAGE (NO AUTOSAVE)
========================= */
const readStore  = () => JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
const writeStore = (all) => localStorage.setItem(STORE_KEY, JSON.stringify(all));
const setLastActive = (name) => { if(name) localStorage.setItem(LAST_ACTIVE_KEY, name); };

function normalizeProject(){
  song.bars = clamp(song.bars||16, 1, MAX_BARS);
  song.bpm  = clamp(song.bpm||120, 40, 240);

  grid = (grid||[]).slice(0,song.bars).map(r => (r||[]).slice(0,BEATS));
  while(grid.length<song.bars) grid.push(Array(BEATS).fill(null));

  for(let b=0;b<song.bars;b++){
    for(let i=0;i<BEATS;i++){
      grid[b][i] = (typeof grid[b][i] === "number") ? grid[b][i] : null;
    }
  }
}

function refreshPlaylist(selectedName=null){
  const all=readStore();
  const keys=Object.keys(all).sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:"base"}));
  const sel=$("playlist");
  sel.innerHTML="";

  const empty=document.createElement("option");
  empty.value="";
  empty.textContent=keys.length ? "Select…" : "No projects";
  sel.appendChild(empty);

  for(const k of keys){
    const opt=document.createElement("option");
    opt.value=k;
    opt.textContent=k;
    sel.appendChild(opt);
  }
  sel.value = (selectedName && keys.includes(selectedName)) ? selectedName : "";
}

function saveToPlaylist(){
  const sel=$("playlist").value;
  const typed=$("projectName").value.trim();
  const name = (typed && typed!==sel) ? typed : (sel || typed);
  if(!name) return alert("Type a project name, or select one in the playlist to overwrite.");

  const all=readStore();
  all[name] = { song, grid, drumsOn };
  writeStore(all);

  $("projectName").value = name;
  refreshPlaylist(name);
  setLastActive(name);
  flashSaved();
}

function loadFromPlaylistName(name){
  if(!name) return;

  const all = readStore();
  const saved = all[name];
  if(!saved) return;

  const data = JSON.parse(JSON.stringify(saved));

  song = data.song || song;
  grid = data.grid || grid;
  drumsOn = !!data.drumsOn;

  normalizeProject();

  $("projectName").value = name;
  $("bpm").value = song.bpm;
  $("barsInput").value = song.bars;

  updateDrumsBtn();

  const existingBars = document.querySelectorAll(".bar").length;
  if(existingBars !== song.bars) drawBars();
  else{
    repaintAllBeats();
    setCursor(0,0,true);
  }

  setLastActive(name);

  if(isPlaying){ stop(); start(); }
  else syncIdlePlayheadToCursor();

  flashSaved();
}

function deleteFromPlaylist(){
  const name=$("playlist").value;
  if(!name) return alert("Select a project to delete.");

  const all=readStore();
  if(!all[name]) return alert("Project not found.");
  if(!confirm(`Delete "${name}" from playlist?`)) return;

  delete all[name];
  writeStore(all);

  const last=localStorage.getItem(LAST_ACTIVE_KEY)||"";
  if(last===name) localStorage.removeItem(LAST_ACTIVE_KEY);

  $("playlist").value="";
  refreshPlaylist();
}

function exportProject(){
  const data={song,grid,drumsOn};
  const safeName=($("projectName").value||"project").replace(/[^\w\-]+/g,"_").slice(0,40);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:"application/json"}));
  a.download=safeName+".json";
  a.click();
}

/* =========================
   LOAD FILE (EXPLORER)
========================= */
function applyLoadedData(data, suggestedName=""){
  if(!data || typeof data!=="object") throw new Error("Invalid file.");

  song = data.song || song;
  grid = data.grid || grid;
  drumsOn = !!data.drumsOn;

  normalizeProject();

  if(suggestedName) $("projectName").value = suggestedName;

  $("bpm").value = song.bpm;
  $("barsInput").value = song.bars;

  updateDrumsBtn();
  drawBars();
  setCursor(0,0,true);

  if(isPlaying){ stop(); start(); }
  else syncIdlePlayheadToCursor();

  flashSaved();
}

async function loadFromFileExplorer(){
  if(window.showOpenFilePicker){
    try{
      const [h] = await window.showOpenFilePicker({
        multiple:false,
        types:[{ description:"Boomwhacker Project (.json)", accept:{ "application/json":[".json"] } }]
      });
      const file = await h.getFile();
      const text = await file.text();
      const data = JSON.parse(text);
      const name = (file.name||"").replace(/\.json$/i,"");
      applyLoadedData(data, name);
      return;
    }catch(_err){
      return;
    }
  }
  $("fileInput").value = "";
  $("fileInput").click();
}

$("fileInput").addEventListener("change", async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    const name = (file.name||"").replace(/\.json$/i,"");
    applyLoadedData(data, name);
  }catch(_err){
    alert("Could not load file. Make sure it is a valid .json export.");
  }
});

/* =========================
   UI EVENTS
========================= */
function updateDrumsBtn(){
  $("drums").textContent = "Drums: " + (drumsOn ? "ON" : "OFF");
  $("drums").classList.toggle("toggledOff", !drumsOn);
}

$("play").onclick = () => isPlaying ? stop() : start();
$("stop").onclick = stop;

$("drums").onclick = ()=>{
  drumsOn=!drumsOn;
  updateDrumsBtn();
};

$("applyBpm").onclick = ()=>{
  song.bpm = clamp((+$("bpm").value||120), 40, 240);
  if(isPlaying){ stop(); start(); }
};

$("applyBars").onclick = ()=>{
  const newBars = clamp((+$("barsInput").value||16), 1, MAX_BARS);
  song.bars = newBars;

  if(grid.length>newBars) grid=grid.slice(0,newBars);
  while(grid.length<newBars) grid.push(Array(BEATS).fill(null));

  drawBars();
  setCursor(0,0,true);

  if(isPlaying){ stop(); start(); }
};

$("saveToPlaylist").onclick = saveToPlaylist;
$("deleteFromPlaylist").onclick = deleteFromPlaylist;
$("export").onclick = exportProject;
$("loadFile").onclick = loadFromFileExplorer;

function playlistAutoLoad(){
  const name = $("playlist").value;
  if(name) loadFromPlaylistName(name);
}
$("playlist").addEventListener("change", playlistAutoLoad);
$("playlist").addEventListener("input", playlistAutoLoad);

$("fs").onclick=()=>{
  if(document.fullscreenElement) document.exitFullscreen();
  else document.documentElement.requestFullscreen();
};

/* =========================
   KEYBOARD INPUT
========================= */
function stepCursorForward(){
  let b=curBar, i=curBeat+1;
  if(i>=BEATS){ i=0; b++; }
  if(b>=song.bars) b=0;
  setCursor(b,i,true);
}

window.addEventListener("keydown",(e)=>{
  if((e.code==="Space" || e.key===" ") && !isTypingTarget(e.target)){
    e.preventDefault();
    isPlaying ? stop() : start();
    return;
  }
  if(isTypingTarget(e.target)) return;

  if(e.key==="ArrowRight"){ e.preventDefault(); setCursor(curBar,curBeat+1,true); return; }
  if(e.key==="ArrowLeft"){  e.preventDefault(); setCursor(curBar,curBeat-1,true); return; }
  if(e.key==="ArrowUp"){    e.preventDefault(); setCursor(curBar-1,curBeat,true); return; }
  if(e.key==="ArrowDown"){  e.preventDefault(); setCursor(curBar+1,curBeat,true); return; }

  if(e.key==="Backspace" || e.key==="Delete"){
    e.preventDefault(); e.stopPropagation();
    setCell(curBar,curBeat,null);
    return;
  }

  if(e.key==="0" || e.key==="." || e.key==="/"){
    e.preventDefault(); e.stopPropagation();
    setCell(curBar,curBeat,null);
    stepCursorForward();
    return;
  }

  const k=(e.key||"").toLowerCase();
  if(Object.prototype.hasOwnProperty.call(KEYMAP,k)){
    const wantLow = ((e.ctrlKey || e.metaKey) && e.shiftKey) || e.altKey;

    if(k==="c" && e.shiftKey && !(e.ctrlKey || e.metaKey)){
      e.preventDefault(); e.stopPropagation();
      const midi=72;
      setCell(curBar,curBeat,midi);
      ensureAudio(); ctx.resume();
      playBoom(midi, ctx.currentTime+.01, .20);
      stepCursorForward();
      return;
    }

    e.preventDefault(); e.stopPropagation();

    let midi = NOTES[KEYMAP[k]].m;
    if(wantLow) midi -= 12;

    setCell(curBar,curBeat,midi);
    ensureAudio(); ctx.resume();
    playBoom(midi, ctx.currentTime+.01, .20);
    stepCursorForward();
  }
},{capture:true});

/* =========================
   INIT
========================= */
window.addEventListener("contextmenu",(e)=>{
  const t = e.target;
  if(t && (t.classList?.contains("beat") || t.closest?.("#bars"))) e.preventDefault();
});

drawPalette();
drawBars();
updateDrumsBtn();
refreshPlaylist();

const last = localStorage.getItem(LAST_ACTIVE_KEY) || "";
if(last){
  const all = readStore();
  if(all[last]){
    refreshPlaylist(last);
    $("playlist").value = last;
    loadFromPlaylistName(last);
  }
}

setCursor(0,0,false);
syncIdlePlayheadToCursor();

})();
</script>
</body>
</html>
